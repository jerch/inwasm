## InWasm - Inline WebAssembly for Typescript.

InWasm is a small bundler for inline standalone wasm libraries. It compiles and bundles
the wasm source code inplace. Example with Typescript:
```typescript
// xy.wasm.ts
import { InWasm, OutputMode, OutputType } from 'inwasm';

const getAdderInstance = InWasm({
  name: 'adder',
  type: OutputType.INSTANCE,
  mode: OutputMode.SYNC,
  srctype: 'C',
  exports: {
    add: (a: number, b: number) => 0
  },
  code: `
    int add(int a, int b) {
      return a + b;
    }`
});
const adderInstance = getAdderInstance();

// use it the wasm instance:
console.log(adderInstance.exports.add(23, 42));  // after compilation: outputs 65
```

Before we can actually use the JS script generated by the TS compiler, we need to
run another build to also compile the wasm source code. 
```bash
# compile wasm source, may pull SDKs (depends on config settings)
inwasm lib/xy.wasm.js
# finally run the module, should output 65
node lib/xy.wasm.js
```
It is important to note, that the compile script will overwrite the original JS script (inplace rewrite).

The final JS script now can be further processed or distributed as any other JS script.


### How does it work under the hood?

`inwasm` loads the JS script as normal module (currently no ESM support!) and catches errors
thown by `InWasm` to get a hold of the callstack and the source code positions. Next it evaluates
the wasm definition (the literal object argument) and calls the compiler backend for the
configured `srctype` with the content of `code`. If the compilation succeeds, the generated
wasm binary gets base64 encoded and wrapped into a runtime definition, which finally replaces
the original wasm definition.
At runtime `InWasm` generates a getter for the requested output type and mode.


### Supported source types, output types, modes

Predefined source types (`srctype`):
- `'C'` (emscripten C)
- `'C++'` (emscripten C++)
- `'Clang-C'` (using clang from emscripten SDK)
- `'Clang-C++'` (using clang from emscripten SDK)
- `'Zig'`
- `'Rust'` (must be preinstalled with `cargo` in PATH)
- `'custom'` (any custom build script)

Output types:
- Uint8Array (raw wasm bytes), typed as `IWasmBytes<T>`
- WebAssembly.Module, typed as `IWasmModule<T>`
- WebAssembly.Instance, typed as `IWasmInstance<T>`

Output modes:
- SYNC
- ASYNC (all output types above as promises)


### Typescript type inference

to be written...


### `InWasm` coding restrictions

to be written...


### Notes about config options and compiler runner

to be written...


### Development

The source repo contains two node package folders:
- `/inwasm` - inwasm package with cli tool and definitions
- `/testproject` - main test package for different compiler runners/SDKs

Since `/testproject` depends on `/inwasm`, initialize in this order:
```bash
git clone https://github.com/jerch/inwasm.git

# setup inwasm first
cd inwasm/inwasm
npm install

# then the testproject
cd ../testproject
npm install
```

### TODO

- ESM support
- better config, option to write to different file
- individual runner config options with proper TS typing
- better docs
- tests, tests, tests


### State

Early alpha, use at your own risk.
